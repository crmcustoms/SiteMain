# Инструкция по деплою сайта на Linux-сервер

## Требования
- Docker
- Git

## Шаги по деплою

### 1. Клонирование репозитория
```bash
git clone <url-репозитория> site
cd site
```

### 2. Настройка прав доступа для скрипта запуска
```bash
chmod +x docker-start.sh
```

### 3. Сборка и запуск контейнера
```bash
./docker-start.sh
```

### 4. Проверка работоспособности
После запуска контейнера сайт будет доступен по адресу http://localhost:3000

### 5. Настройка Nginx (если нужен доступ извне)
Пример конфигурации Nginx для проксирования запросов к контейнеру:

```nginx
server {
    listen 80;
    server_name ваш-домен.com www.ваш-домен.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 6. Настройка SSL с Let's Encrypt
```bash
sudo apt-get update
sudo apt-get install certbot python3-certbot-nginx
sudo certbot --nginx -d ваш-домен.com -d www.ваш-домен.com
```

## Обновление сайта

Для обновления сайта выполните следующие команды:

```bash
# Переходим в директорию с проектом
cd site

# Получаем последние изменения из репозитория
git pull

# Перезапускаем контейнер
./docker-start.sh
```

## Просмотр логов
```bash
docker logs -f crmcustoms-site
```

## Остановка контейнера
```bash
docker stop crmcustoms-site
```

## Удаление контейнера
```bash
docker stop crmcustoms-site
docker rm crmcustoms-site
```

## Возможные проблемы и их решение

### 1. Ошибка с доступом к изображениям S3
Если изображения из S3 не отображаются, проверьте:
- Доступ к S3 бакету с сервера (проверьте, что порты 443/80 не заблокированы)
- Правильность URL в API прокси (app/api/s3-proxy/route.ts)
- Логи в консоли браузера на наличие ошибок 400/403/404
- Логи сервера: `docker logs crmcustoms-site | grep "S3 proxy"`

Решение:
- Проверьте доступность S3 бакета с сервера: `curl -v https://s3.us-east-1.amazonaws.com/crmcustoms.site/`
- Убедитесь, что в Dockerfile копируется файл api-routes.js: `cp api-routes.js .next/standalone/`
- Проверьте, что в express-server.js правильно настроены маршруты для /api/s3-proxy/ и /s3-proxy/

### 2. Дублирование хедеров и футеров
Если наблюдается дублирование хедеров и футеров:
- Убедитесь, что в app/layout.tsx нет хедера и футера
- Проверьте, что хедер и футер добавляются только в app/[lang]/layout.tsx

### 3. Проблемы с редиректами
Если редиректы не работают:
- Проверьте файлы app/page.tsx, app/blog/page.tsx и app/cases/page.tsx
- Убедитесь, что используется правильный локализованный путь (/uk/...)

### 4. Проблемы с Docker
Если контейнер не запускается:
- Проверьте логи: `docker logs crmcustoms-site`
- Убедитесь, что порт 3000 не занят другим приложением: `netstat -tulpn | grep 3000`
- Проверьте наличие достаточного места на диске: `df -h`
- Проверьте, что у пользователя есть права на запуск Docker: `groups | grep docker`

### 5. Ошибка "powershell: not found"
Если при сборке Docker-образа возникает ошибка "powershell: not found":
- Убедитесь, что вы используете последнюю версию Dockerfile из репозитория
- Проверьте, что в package.json удалены скрипты, использующие PowerShell
- Используйте скрипт docker-start.sh для запуска на Linux

## Последние изменения (важно!)

### Текущие изменения (версия 1.2.0)

1. **Исправлены проблемы с Docker на Linux:**
   - Удалены PowerShell-команды из package.json
   - Добавлена установка git в Dockerfile: `apk add --no-cache git`
   - Изменен процесс сборки для использования прямых Linux-команд
   - Добавлено копирование api-routes.js в контейнер

2. **Улучшена обработка S3 URL:**
   - Добавлена поддержка различных форматов S3 URL
   - Вынесена логика обработки URL в отдельную функцию getS3ProxyUrl
   - Добавлена поддержка формата `s3.amazonaws.com/crmcustoms.site/`
   - Добавлена поддержка формата `crmcustoms.site.s3.us-east-1.amazonaws.com/`

3. **Улучшена обработка ошибок:**
   - Добавлено подробное логирование для отладки
   - Добавлена проверка доступности сайта после запуска
   - Добавлен эндпоинт /health для проверки работоспособности

### Предстоящие изменения интерфейса

В ближайшем обновлении будут внесены следующие изменения в интерфейс сайта:

1. **Мобильное меню**
   - Добавление мобильного меню для всех страниц сайта
   - Улучшение навигации на мобильных устройствах

2. **Хедер на страницах лендингов**
   - Добавление хедера на все страницы лендингов для единообразия интерфейса
   - Улучшение навигации между разделами сайта

3. **Сайдбар на страницах кейсов**
   - Восстановление сайдбара на внутренних страницах кейсов
   - Улучшение навигации и фильтрации контента

4. **Улучшение отображения обложек**
   - Увеличение размера обложек на детальных страницах
   - Исправление обрезки изображений

### Действия при деплое

1. Убедитесь, что вы обновили все файлы, включая:
   - `express-server.js`
   - `api-routes.js`
   - `Dockerfile`
   - `package.json`
   - `docker-start.sh`
   - Компоненты с исправленными путями к S3 прокси

2. Проверьте логи сервера после деплоя:
   - Ищите запросы к `/api/s3-proxy/` и `/s3-proxy/`
   - Убедитесь, что оба маршрута обрабатываются корректно

3. Если проблемы с изображениями сохраняются:
   - Проверьте консоль браузера на наличие ошибок 404
   - Проверьте логи Docker: `docker logs crmcustoms-site | grep "S3 proxy"`
   - Убедитесь, что в S3 бакете есть запрашиваемые файлы
   - Проверьте сетевую доступность S3 с сервера: `curl -v https://s3.us-east-1.amazonaws.com/crmcustoms.site/`

4. После обновления интерфейса:
   - Проверьте корректную работу мобильного меню
   - Убедитесь, что хедер отображается на всех страницах лендингов
   - Проверьте функциональность сайдбара на страницах кейсов
   - Проверьте правильное отображение обложек 