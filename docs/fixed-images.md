# Исправление загрузки изображений (блог и кейсы)

## Что было

На внутренних страницах не загружались изображения из контента (Notion/личный S3). В HTML попадали относительные пути или ссылки через локальный прокси `/api/s3-proxy/...`, что приводило к 404/ошибкам загрузки и показу заглушек.

## Текущее поведение (после фикса)

- Личные S3 URL (обложки и внутренние картинки) используются напрямую, без принудительного прокси.
- Любые `src` вида `/api/s3-proxy/<encoded>` на клиенте и на сервере разворачиваются обратно в абсолютный URL, если внутри действительно `http/https`.
- Для относительных/локальных путей выставляется плейсхолдер `/api/placeholder`.
- Ошибки загрузки перехватываются и подменяются плейсхолдером, чтобы страница не падала.

## Где что сделано

- `lib/blog.ts`
  - Убрано принудительное оборачивание S3 ссылок в `/api/s3-proxy/...`. Абсолютные URL остаются без изменений.
  - Плейсхолдеры ставятся только для действительно некорректных путей.

- `app/[lang]/blog/[slug]/page.tsx`
  - `prepareHtmlForServer` разворачивает `/api/s3-proxy/<encoded>` в абсолютный URL (если внутри `http/https`).
  - Добалены атрибуты `loading="lazy"`, `decoding="async"`, базовые стили и безопасный `onerror`.

- `components/blog/DirectHtmlContent.tsx` и `components/common/DirectImage.tsx`
  - На клиенте разворачивают `/api/s3-proxy/<encoded>` в абсолютный URL.
  - Добавлены обработчики ошибок, ленивая загрузка и стили.

- `app/api/s3-proxy/route.ts`
  - Оставлен как совместимый маршрут для случаев, когда нужно проксировать абсолютный URL (но по умолчанию больше не обязателен для личного S3).

## Как запустить локально

```bash
npx next dev -p 3020
```

Открыть: `http://localhost:3020/uk` и нужную внутреннюю страницу блога.

## Чек-лист проверки

- Изображения из личного S3 отображаются без прокси.
- На странице нет `src` с относительными/localhost путями; если они есть — показывается плейсхолдер.
- При ошибке загрузки появляется плейсхолдер, страница не падает.
- Консоль браузера без критических ошибок.

## Примечания

- Notion presigned URL также поддерживаются напрямую (если присутствуют). Срок действия таких ссылок ограничен — при истечении будет плейсхолдер.