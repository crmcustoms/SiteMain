# Устранение проблем с изображениями

## Источники изображений в проекте

1. **Обложки и иллюстрации сайта**
   - Хранятся на личном S3 сервере (crmcustoms.site)
   - Обрабатываются через стандартный S3-прокси
   - URL формат: `s3.amazonaws.com/crmcustoms.site/...` или `crmcustoms.site.s3.amazonaws.com/...`

2. **Внутренние изображения из Notion**
   - Хранятся на S3 сервере Notion
   - Имеют другой формат URL: `prod-files-secure.s3.us-west-2.amazonaws.com/...`
   - Содержат параметры безопасности AWS (X-Amz-Algorithm, X-Amz-Credential и т.д.)
   - Требуют специальной обработки в S3-прокси

## Обработка изображений (актуально)

### Прямые URL
- Абсолютные S3-ссылки (личный бакет и Notion presigned) используются напрямую, без обязательного прокси.
- Внутренние страницы формируются в `lib/blog.ts` без принудительного оборачивания в `/api/s3-proxy`.

### Разворачивание `/api/s3-proxy/<encoded>`
- На сервере: `app/[lang]/blog/[slug]/page.tsx` (функция `prepareHtmlForServer`) — если внутри прокси закодирован `http/https`, разворачивает в прямой URL.
- На клиенте: `components/blog/DirectHtmlContent.tsx` и `components/common/DirectImage.tsx` — зеркальная логика разворачивания и обработка ошибок.

### Плейсхолдер
- API: `app/api/placeholder/route.ts` — возвращает SVG заглушку.
- Используется при относительных путях, ошибках загрузки и истечении presigned ссылок.

### Опциональный S3-прокси
- `app/api/s3-proxy/route.ts` можно использовать для явного проксирования абсолютных URL (например, для CORS/заголовков). По умолчанию для личного S3 не требуется.

## Распространенные проблемы

1. **Изображения не загружаются**
   - Проверить доступ к S3 бакетам
   - Если используете прокси — убедиться, что он поддерживает нужные домены
   - Проверить наличие заглушек

2. **Ошибки 403/404 при загрузке изображений**
   - Возможно истек срок действия подписанных URL из Notion
   - Проверить права доступа к S3 бакетам
   - Если используете прокси — убедиться, что он корректно обрабатывает URL с параметрами безопасности

3. **Медленная загрузка изображений**
   - Проверить работу кеширования в S3-прокси
   - Оптимизировать размер изображений 